@page "/phieuxuatkho/print/{id:int}"
@using TKS_intern_shared.ViewModels.PhieuXuatKhos
@using TKS_intern_shared.ViewModels.ChiTietPhieuXuatKhos
@using TKS_intern_client.Services
@layout PrintLayout

@inject ApiClient Api
@inject IJSRuntime JS
@inject NavigationManager Navigation

<PageTitle>In Phiếu Xuất Kho</PageTitle>

@if (phieu == null)
{
    <p>Đang tải dữ liệu...</p>
}
else
{
    <div>
        <div class="info">
            <div class="left">
                <div><strong>Đơn vị:</strong> Công ty ABC</div>
                <div><strong>Bộ phận:</strong> Kho hàng</div>
                <div><strong>Ngày:</strong> @phieu.NgayXuatKho.ToString("dd/MM/yyyy")</div>
                <div><strong>Số phiếu:</strong> @phieu.SoPhieuXuatKho</div>
                <div><strong>Kho xuất:</strong> @phieu.Kho?.TenKho</div>
            </div>
            <div class="right">
                <div><strong>Mẫu số:</strong> 02 - VT</div>
                <div>(Ban hành theo QĐ số 15/2006/QĐ-BTC)</div>
                <div>Ngày 20/03/2006 của Bộ trưởng BTC</div>
            </div>
        </div>

        <div class="title">PHIẾU XUẤT KHO</div>

        <table>
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Tên nhãn hiệu, quy cách, phẩm chất</th>
                    <th>Mã hàng</th>
                    <th>ĐVT</th>
                    <th>Số lượng</th>
                    <th>Đơn giá</th>
                    <th>Thành tiền</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var (item, index) in ChiTietPhieuXuatKhos.Select((x, i) => (x, i + 1)))
                {
                    <tr>
                        <td>@index</td>
                        <td>@item.SanPham?.TenSanPham</td>
                        <td>@item.SanPham?.MaSanPham</td>
                        <td>@item.SanPham?.DonViTinh.TenDonViTinh</td>
                        <td>@item.SoLuongXuat</td>
                        <td>@item.DonGiaXuat.ToString("N0")</td>
                        <td>@((item.SoLuongXuat * item.DonGiaXuat).ToString("N0"))</td>
                    </tr>
                }
                <tr>
                    <td colspan="4"><strong>Tổng cộng</strong></td>
                    <td><strong>@ChiTietPhieuXuatKhos.Sum(x => x.SoLuongXuat)</strong></td>
                    <td></td>
                    <td><strong>@ChiTietPhieuXuatKhos.Sum(x => x.SoLuongXuat * x.DonGiaXuat).ToString("N0")</strong></td>
                </tr>
            </tbody>
        </table>

        <div style="margin-top: 20px;">
            <strong>Tổng số tiền (viết bằng chữ):</strong>
            <i>@ToWords(ChiTietPhieuXuatKhos.Sum(x => x.SoLuongXuat * x.DonGiaXuat)) đồng</i>
        </div>

        <div style="margin-top: 20px;">
            <strong>Chứng từ gốc kèm theo:</strong> ................................................................................
        </div>

        <div class="signatures">
            <div class="signature-block">
                Người lập phiếu<br /><br /><br /><br />....................................
            </div>
            <div class="signature-block">
                Người nhận hàng<br /><br /><br /><br />....................................
            </div>
            <div class="signature-block">
                Thủ kho<br /><br /><br /><br />....................................
            </div>
            <div class="signature-block">
                Kế toán trưởng<br /><br /><br /><br />....................................
            </div>
        </div>

        <div class="no-print">
            <button @onclick="PrintPage" class="btn btn-primary">In phiếu</button>
            <button @onclick="Back" class="btn btn-outline-primary">Quay lại</button>
        </div>
    </div>
}

@code {
    [Parameter] public int id { get; set; }

    private PhieuXuatKhoVM? phieu;
    private List<ChiTietPhieuXuatKhoVM> ChiTietPhieuXuatKhos = new();

    protected override async Task OnInitializedAsync()
    {
        phieu = await Api.GetAsync<PhieuXuatKhoVM>($"api/PhieuXuatKhos/{id}");
        var chiTiet = await Api.GetAsync<List<ChiTietPhieuXuatKhoVM>>($"api/ChiTietPhieuXuatKhos/phieuXuatKho/{id}");
        if (chiTiet != null)
        {
            ChiTietPhieuXuatKhos = chiTiet;
        }
    }

    private async Task PrintPage()
    {
        await JS.InvokeVoidAsync("window.print");
    }

    private void Back()
    {
        Navigation.NavigateTo($"/phieuxuatkho/detail/{id}");
    }

    private string ToWords(decimal number)
    {
        return PrintHelper.ToWords(number);
    }
}
