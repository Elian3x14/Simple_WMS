@page "/sanpham/create"
@using TKS_intern_client.Services
@using TKS_intern_client.Shared.Forms
@using TKS_intern_shared.ViewModels.SanPhams
@using TKS_intern_shared.ViewModels.LoaiSanPhams
@using TKS_intern_shared.ViewModels.DonViTinhs
@inject ApiClient Api
@inject NavigationManager Navigation

<h3>Thêm mới Sản Phẩm</h3>

@if (loaiSanPhamList is null || donViTinhList is null)
{
    <p><em>Đang tải dữ liệu...</em></p>
}
else
{
    <SanPhamForm Model="model"
                 LoaiSanPhamList="loaiSanPhamList"
                 DonViTinhList="donViTinhList"
                 OnValidSubmitCallback="HandleValidSubmit"
                 OnCancel="Cancel" />
}

@code {
    private SanPhamSaveVM model = new();
    private List<LoaiSanPhamVM>? loaiSanPhamList;
    private List<DonViTinhVM>? donViTinhList;

    protected override async Task OnInitializedAsync()
    {
        loaiSanPhamList = await Api.GetAsync<List<LoaiSanPhamVM>>("api/LoaiSanPhams");
        donViTinhList = await Api.GetAsync<List<DonViTinhVM>>("api/DonViTinhs");
    }

    private async Task HandleValidSubmit()
    {
        var response = await Api.PostAsync("api/SanPhams", model);
        if (response.IsSuccessStatusCode)
        {
            Navigation.NavigateTo("/sanpham");
        }
        else
        {
            Console.WriteLine("Thêm thất bại: " + response.StatusCode);
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/sanpham");
    }
}
