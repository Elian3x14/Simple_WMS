@page "/phieunhapkho/print/{id:int}"
@using TKS_intern_shared.ViewModels.PhieuNhapKhos
@using TKS_intern_shared.ViewModels.ChiTietPhieuNhapKhos
@using TKS_intern_client.Services
@layout PrintLayout

@inject ApiClient Api
@inject IJSRuntime JS
@inject NavigationManager Navigation

<PageTitle>In phiếu nhập kho</PageTitle>

@if (phieu == null)
{
    <p>Đang tải dữ liệu...</p>
}
else
{
    <div>
        <div class="info">
            <div class="left">
                <div><strong>Đơn vị:</strong> Công ty ABC</div>
                <div><strong>Bộ phận:</strong> Kho hàng</div>
                <div><strong>Ngày:</strong> @phieu.NgayNhapKho.ToString("dd/MM/yyyy")</div>
                <div><strong>Số phiếu:</strong> @phieu.SoPhieuNhapKho</div>
                <div><strong>Nhà cung cấp:</strong> @phieu.NhaCungCap?.TenNhaCungCap</div>
                <div><strong>Kho nhập:</strong> @phieu.Kho?.TenKho</div>
            </div>
            <div class="right">
                <div><strong>Mẫu số:</strong> 01 - VT</div>
                <div>(Ban hành theo QĐ số 15/2006/QĐ-BTC)</div>
                <div>Ngày 20/03/2006 của Bộ trưởng BTC</div>
            </div>
        </div>

        <div class="title">PHIẾU NHẬP KHO</div>

        <table>
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Tên nhãn hiệu, quy cách, phẩm chất</th>
                    <th>Mã hàng</th>
                    <th>ĐVT</th>
                    <th>Số lượng</th>
                    <th>Đơn giá</th>
                    <th>Thành tiền</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var (item, index) in ChiTietPhieuNhapKhos.Select((x, i) => (x, i + 1)))
                {
                    <tr>
                        <td>@index</td>
                        <td>@item.SanPham?.TenSanPham</td>
                        <td>@item.SanPham?.MaSanPham</td>
                        <td>@item.SanPham?.DonViTinh.TenDonViTinh</td>
                        <td>@item.SoLuongNhap</td>
                        <td>@item.DonGiaNhap.ToString("N0")</td>
                        <td>@((item.SoLuongNhap * item.DonGiaNhap).ToString("N0"))</td>
                    </tr>
                }
                <tr>
                    <td colspan="4"><strong>Tổng cộng</strong></td>
                    <td><strong>@ChiTietPhieuNhapKhos.Sum(x => x.SoLuongNhap)</strong></td>
                    <td></td>
                    <td><strong>@ChiTietPhieuNhapKhos.Sum(x => x.SoLuongNhap * x.DonGiaNhap).ToString("N0")</strong></td>
                </tr>
            </tbody>
        </table>

        <div style="margin-top: 20px;">
            <strong>Tổng số tiền (viết bằng chữ):</strong>
            <i>@ToWords(ChiTietPhieuNhapKhos.Sum(x => x.SoLuongNhap * x.DonGiaNhap)) đồng</i>
        </div>

        <div style="margin-top: 20px;">
            <strong>Chứng từ gốc kèm theo:</strong> ................................................................................
        </div>

        <div class="signatures">
            <div class="signature-block">
                Người lập phiếu<br /><br /><br /><br />....................................
            </div>
            <div class="signature-block">
                Người giao hàng<br /><br /><br /><br />....................................
            </div>
            <div class="signature-block">
                Thủ kho<br /><br /><br /><br />....................................
            </div>
            <div class="signature-block">
                Kế toán trưởng<br /><br /><br /><br />....................................
            </div>
        </div>

        <div class="no-print">
            <button @onclick="PrintPage" class="btn btn-primary">In phiếu</button>
            <button @onclick="Back" class="btn btn-outline-primary">Quay lại</button>
        </div>
    </div>
}

@code {
    [Parameter] public int id { get; set; }

    private PhieuNhapKhoVM? phieu;
    private List<ChiTietPhieuNhapKhoVM> ChiTietPhieuNhapKhos = new();

    protected override async Task OnInitializedAsync()
    {
        phieu = await Api.GetAsync<PhieuNhapKhoVM>($"api/PhieuNhapKhos/{id}");
        var chiTiet = await Api.GetAsync<List<ChiTietPhieuNhapKhoVM>>($"api/ChiTietPhieuNhapKhos/phieuNhapKho/{id}");
        if (chiTiet != null)
        {
            ChiTietPhieuNhapKhos = chiTiet;
        }
    }

    private async Task PrintPage()
    {
        await JS.InvokeVoidAsync("window.print");
    }

    private void Back()
    {
        Navigation.NavigateTo("/phieunhapkho/detail/" + id);
    }

    private string ToWords(decimal number)
    {
        return PrintHelper.ToWords(number);
    }

}
